# Nama Workflow: "Deploy to Production VPS"
name: Deploy to Production VPS

# Trigger: Kapan workflow ini berjalan
on:
  push:
    branches:
      - main  # Ganti ini jika branch utama Anda 'master'

# Jobs: Daftar pekerjaan yang harus dilakukan
jobs:
  deploy:
    # Menggunakan runner Ubuntu terbaru dari GitHub
    runs-on: ubuntu-latest

    # Menggunakan "vps_deploy" environment untuk mengambil secrets
    environment: vps_deploy

    steps:
      # 1. Checkout Kode
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. SSH dan Deploy
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          
          # Menggunakan "set -e" agar skrip otomatis GAGAL
          # jika ada satu perintah yang error
          script: |
            set -e
            
            # Masuk ke direktori proyek
            cd ${{ secrets.VPS_PATH }}
            
            # 1. Ambil kode terbaru
            echo "1. Pulling latest code..."
            git pull origin main
            
            # 2. Matikan semua container yang sedang berjalan
            echo "2. Stopping old containers..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose down --remove-orphans

            echo "3. Installing Composer dependencies..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker run --rm -v $(pwd):/app -w /app composer/composer install --optimize-autoloader

            # 5. Install NPM & Build Aset (INI JUGA PENTING)
            echo "4. Installing NPM dependencies and building assets..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker run --rm -v $(pwd):/app -w /app node:20 npm install
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker run --rm -v $(pwd):/app -w /app node:20 npm run build

            # (PERBAIKAN BARU) Bersihkan semua container "hantu"
            echo "3. Pruning old containers, networks, and images..."
            sudo docker container prune -f
            
            # 3. Mulai build
            echo "4. Building new containers..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose build
            
            # 4. Nyalakan container baru
            echo "5. Starting new containers..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose up -d
            
            # 5. Jalankan migrasi
            echo "5. Running database migrations..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose exec laravel.test php artisan migrate --force

            # 7. Build aset frontend
            echo "7. Building frontend assets..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose exec laravel.test npm run production

            # 8. Bersihkan cache
            echo "8. Optimizing application..."
            sudo WWWUSER=${{ secrets.WWWUSER }} WWWGROUP=${{ secrets.WWWGROUP }} docker compose exec laravel.test php artisan optimize:clear
            
            echo "Deployment finished successfully!"

