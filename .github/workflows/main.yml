# Nama Workflow: "Deploy to Production VPS"
name: Deploy to Production VPS

# Trigger: Kapan workflow ini berjalan
on:
  push:
    branches:
      - main  # Ganti ini jika branch utama Anda 'master'

# Jobs: Daftar pekerjaan yang harus dilakukan
jobs:
  deploy:
    # Menggunakan runner Ubuntu terbaru dari GitHub
    runs-on: ubuntu-latest

    # Menggunakan "vps_deploy" environment untuk mengambil secrets
    environment: vps_deploy

    steps:
      # 1. Checkout Kode
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. SSH dan Deploy
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          
          # Menggunakan "set -e" agar skrip otomatis GAGAL
          # jika ada satu perintah yang error
          script: |
            set -e
            
            # Masuk ke direktori proyek
            cd ${{ secrets.VPS_PATH }}
            
            # 1. Ambil kode terbaru
            echo "1. Pulling latest code..."
            git pull origin main

            echo "2. Exporting build variables..."
            export WWWUSER=1000
            export WWWGROUP=1000
            
            # 2. (PERBAIKAN ERROR #2)
            # Matikan semua container yang sedang berjalan
            echo "3. Stopping old containers..."
            sudo docker compose down
            
            # 4. Rangkai semua perintah "wajib" dengan "&&"
            # "&&" berarti "Hanya lanjutkan jika perintah sebelumnya SUKSES"
            echo "4. Running build, migrations, and optimization..."
            
            sudo docker compose build && \
            sudo docker compose up -d && \
            sudo docker compose exec laravel-app php artisan migrate --force && \
            sudo docker compose exec laravel-app npm run build && \
            sudo docker compose exec laravel-app php artisan optimize:clear
            
            echo "Deployment finished successfully!"

